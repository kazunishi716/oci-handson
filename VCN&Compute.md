# OCIハンズオン-VCN&Compute編

- ハンズオン-作業イメージ&前提
- ハンズオン用のコンパートメント作成
- VCN作成
- Compute作成&アクセス

## ハンズオン-作業イメージ&前提
- コンパートメント/VCN/Computeを作成するために必要なポリシーが付与されていること。
- インターネット経由でComputeにsshするアクセスするところまでとなります。
- ※インターネット経由でのアクセス不可の場合はOCI Webコンソールからのプライベートアクセスも可能です。
- 作成するComputeのOSはOracle Linuxです。

下記がこのハンズオンで作成できる構成イメージです。
![image](https://github.com/kazunishi716/oci-handson/assets/153155301/bcc72cc5-86ed-4e54-82d6-ec7fab064d4e)

## ハンズオン用のコンパートメント作成

1. メニュー > ②アイデンティティとセキュリティ > ③コンパートメント
1. 「コンパートメントの作成」をクリック
1. 「名前」「説明」に”handson”と入力
   1. 名前 - handson
   1. 説明 - handson
   1. 親コンパートメント - ○○○○(ルート) を選択 
1. 「コンパートメントの作成」をクリック

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/98d6c598-c900-4873-b641-e8ef3a4904e5)

## VCN作成

1. コンソールメニューから ネットワーキング → 仮想クラウド・ネットワーク を選択し、VCNウィザード ボタンを押します。
   ※この際、左下の ”リスト範囲” でリソースを 作成したいコンパートメントを選択していることを確認してください。ここでは handson コンパートメントを作成して使用しています。
2. 立ち上がった VCNウィザード ウィンドウで、デフォルトの ”インターネット接続性を持つVCN” を選択した状態で VCNウィザードの起動 をクリックします。このタイプを選択すると、以下のコンポーネントが作成されます。
   1. VCN
   2. パブリック・サブネット
   3. プライベート・サブネット
   4. インターネット・ゲートウェイ(IG)
   5. NATゲートウェイ(NAT)
   6. サービス・ゲートウェイ(SG)

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/02b45bd8-8aea-4d80-a3f1-129856e7cbbf)

3. インターネット接続性を持つVCNの作成 ウィンドウに以下の項目を入力し、次 ボタンを押します。
   1. VCN名:handson-vcn
   2. コンパートメント: HandsOn
   3. VCN CIDRブロック: デフォルト(10.0.0.0/16)
   4. パブリック・サブネットCIDRブロック: デフォルト(10.0.0.0/24)
   5. プライベート・サブネットCIDRブロック: デフォルト(10.1.0.0/24)
4. 次の 確認および作成 画面で、これから作成されるリソースを確認し、作成 ボタンをクリックします。
5. 仮想クラウド・ネットワークが作成されます。

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/80c46acd-c840-4043-a632-35adb2f954d1)

## Compute作成&アクセス
### Compute作成

1. コンソールメニューから コンピュート → インスタンス を選択します。
1. インスタンスの作成 ボタンを押します
1. 立ち上がった ”コンピュート・インスタンスの作成” ウィンドウに 以下の項目を入力し、作成 ボタンを押下します。
  1. 名前: web-instance1
  1. コンパートメントに作成: handson
  1. 可用性ドメイン: AD1
  1. イメージ: Oracle Linux 8
  1. インスタンス・タイプ: 仮想マシン
  1. シェイプ・シリーズ: AMD
  1. シェイプ: VM.Standard.E4.Flex
     1. OCPU: 1
     1. メモリー量: 8
　1. プライマリVNIC情報
     1. VNIC名：空白
     1. プライマリ・ネットワーク: 既存の仮想クラウド・ネットワークを選択
     1. [コンパートメント名]の仮想クラウド・ネットワーク: handson-vcn
     1. サブネット: 既存のサブネットを選択
     1. [コンパートメント名]のサブネット: パブリック・サブネット- handson-vcn
  1. プライマリVNIC IPアドレス
     1. プライベートIPv4アドレス：プライベートIPv4アドレスの自動割当て
     1. パブリックIPv4アドレス：パブリックIPv4アドレスの自動割り当て
     1. IPv6アドレス：未チェック
  1. SSHキーの追加
     1. キー・ペアを自動で生成：選択
     1. 秘密キーの保存、公開キーの保存を実施
  1. ブート・ボリュームの構成
     1. カスタム・ブート・ボリューム・サイズを指定します:チェックなし
     1. 転送中暗号化の使用: チェックあり
     1. 自分が管理するキーでこのボリュームを暗号化: チェックなし
  1. ブロックボリューム：空白
  1. 作成 ボタン押下後、インスタンスの作成が開始され、ステータスが プロビジョニング中 になっていることを確認します。
  1. インスタンスの作成が完了すると、アイコンが黄色から緑色にかわり、ステータス表示が 実行中 に変わります。

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/c0fa7aea-bd83-4093-881c-3afb57c386a6)

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/cf7d5bfa-b343-4fe5-bf28-5007331a87c2)

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/77f504b8-483f-416a-a83e-7f7b817ce654)

### Computeへのアクセス
1. インスタンスの一覧画面から、instance リンクをクリックするか、右側の トリコロン から インスタンスの詳細の表示 を選択し、インスタンス詳細画面を開きます
2. 上部の ”パブリックIPアドレス” を確認します

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/1d678c89-f30e-403b-9184-3e62641c83ff)

#### sshクライアントツール利用時
1. 任意のssh接続クライアントツールを起動します(ex.putty,teraterm, Visual Studio Code…)
2. IPアドレスの入力、インスタンス作成時にダウンロードした秘密鍵を利用します
3. ユーザ名”opc”を入力します
4. 無事アクセスできれば作業完了です

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/c4ec926e-2661-4a9c-a994-745f570a3095)
![image](https://github.com/kazunishi716/oci-handson/assets/153155301/297f1c8a-7314-4b8a-9393-97fec8d1a501)

#### コマンドプロンプト利用時
1. コマンドプロンプトを起動します
2. 以下コマンドでssh接続をします。
※秘密鍵の配置しているディレクトリで実施想定。もしくは秘密鍵の絶対パスを指定してください
```
ssh opc@<パブリックIPアドレス> -i <秘密鍵>
```
3. 無事アクセスできれば作業完了です

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/9e8db7df-10b7-4cd2-9e44-cdb79cd5584e)

#### ご参考 - Cloud Shellを利用したOCI Web コンソールからのプライベートアクセス
プライベートサブネットに構築したComputeに対し、踏み台サーバを利用せずに接続する方法
※プライベートサブネットにComputeを構築していることを前提とします

1. Cloud Shell アイコンをクリックします。
1. コンソール画面の下部にCloud Shellが起動され、 「Oracle Cloud Shell へようこそ。」と表示されていれば起動は完了です。

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/b3d65aa7-aefd-4432-83ae-ca20bf91051d)

3. ダウンロードしておいたSSH鍵のうち、秘密鍵 (～.keyファイル) をCloud Shellへドラッグ＆ドロップします。
4. 秘密鍵ファイルがCloud Shell環境へ転送されます。完了するとCloud Shell右上に「完了済」と表示されます。

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/64eebc93-6b29-435e-9c10-797b4b5fd1b2)

5. 「プライベート・ネットワーク設定」を選択
6. 接続したいコンピュートが配置されているVCNとサブネットを選択し、「このネットワークに接続」を押す
7. 「ネットワーク：プライベート」になっていることを確認

![image](https://github.com/kazunishi716/oci-handson/assets/153155301/4f1c610a-0f66-4c59-a512-3dfb9f813e12)


8. Cloud Shell上で以下のコマンドを入力し、Enterキーを押します。
```
chmod 400 <アップロードした秘密鍵ファイル名>
```

9. 続いて以下のコマンドを入力し、 Enterキーを押します。 
```
ssh opc@<コンピュートのプライベートIPアドレス> -i <アップロードした秘密鍵ファイル名>
```

10. 初回接続時は、接続してよいかの 確認がされます。「yes」と入力し、 Enterキーを押下します。 
11. 以下のように表示されていれば、 SSH接続の完了です。
```
[opc@<ホスト名> ~]$
```
![image](https://github.com/kazunishi716/oci-handson/assets/153155301/3a69dc6c-f06b-4293-9a07-2d8bc309a95a)

### ご参考 - セキュリティ・リストについて (ex.RDP接続用のネットワーク設定)
OCIのセキュリティ・リストはデフォルトでポート22(ssh)がアクセスできますが、それ以外のものは随時追加する必要があります。
今回はWindows Serverを構築した場合を想定したRDP接続用のセキュリティ・リスト設定作業を実施してみます。

1. コンソールメニューからネットワーキング → 仮想クラウドネットワーク を選択します。
1. VCN一覧から [handson-vcn] を選択します。
1. サブネット一覧から [パブリック・サブネット-handson-vcn]を選択します。
1. セキュリティ・リストの一覧から [Default Security List for handson-vcn] を選択します。
1. イングレス・ルールの追加 を選択します。
1. 以下のルールを追加します。
   1. ソース・タイプ: CIDR
   1. ソースCIDR: 0.0.0.0/0
   1. IPプロトコル: RDP(TCP/3389)
1. イングレス・ルールの追加 を選択します。

 こちらを適用することで対象のパブリックサブネット上に構築したWindows Severへのアクセスすることが可能となります。
 この要領でMySQL(3306)など必要なものがあれば随時追加する必要があります。

 
